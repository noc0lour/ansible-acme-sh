---
- name: Set OS dependent variables
  include_vars: "{{ item }}"
  with_first_found:
   - "{{ ansible_distribution }}_{{ ansible_distribution_major_version }}.yml"
   - "{{ ansible_distribution }}.yml"
   - "{{ ansible_os_family }}_{{ ansible_distribution_major_version }}.yml"
   - "{{ ansible_os_family }}.yml"
   - default.yml

- name: OS is supported
  assert:
    that: acme_sh_os_supported == True

- name: Create ACME.sh user
  user:
      name: '{{ acme_user }}'
      home: '{{ acme_home_dir }}'
      state: present

- name: Install necessary packages
  action: >
      {{ ansible_pkg_mgr }}
      name="{{ acme_sh_packages }}"
      state=present

- name: "Tighten permissions on ACME homedir"
  file:
    path: '{{ acme_home_dir }}'
    mode: '700'

- name: "Create ACME pki dir"
  file:
    dest: '{{ acme_pki_dir }}'
    owner: '{{ acme_pki_dir_owner }}'
    group: '{{ acme_pki_dir_group }}'
    mode: '{{ acme_pki_dir_permissions }}'
    state: directory

- name: "Download acme.sh archive"
  get_url:
    url: "{{ acme_archive_url }}"
    dest: "{{ acme_archive }}"
    checksum: "{{ acme_archive_checksum }}"
    mode: "0755"

- name: "Create ACME script dirr"
  file:
    dest: '{{ acme_script_dir }}'
    owner: '{{ acme_user }}'
    group: '{{ acme_group }}'
    mode: '{{ acme_permissions }}'
    state: directory

- name: "Create ACME cert base dir"
  file:
    dest: '{{ acme_cert_base }}'
    owner: '{{ acme_user }}'
    group: '{{ acme_group }}'
    mode: '{{ acme_permissions }}'
    state: directory


- name: "Unpack acme.sh archive "
  unarchive:
    remote_src: True
    src: "{{ acme_archive }}"
    dest: "{{ acme_script_dir }}"
    owner: "{{ acme_user }}"
    extra_opts: [--strip-components=1 ]

- name: "Install .acme.sh"
  become_user: '{{ acme_user }}'
  become: yes
  shell: '{{ acme_script_dir }}/acme.sh --install --home {{ acme_data_dir }}'
  args:
    chdir: '{{ acme_script_dir }}'
    creates: '{{ acme_data_dir }}/.acme.sh'
  changed_when: false

- name: "Update accountemail if var is set"
  become_user: '{{ acme_user }}'
  become: yes
  shell: '{{ acme_data_dir }}/acme.sh --updateaccount --acountemail {{ acme_accountemail }}'
  when: acme_accountemail is defined

- name: "Issue certs if configured"
  become_user: '{{ acme_user }}'
  become: yes
  shell: '{{ acme_environ }} {{ acme_data_dir }}/acme.sh --issue {{ item.issue_mode }} -d {{ item.domains|join(" -d ") }}'
  register: acme_issue_result
  changed_when: not acme_issue_result.stdout|search("Domains not changed")
  failed_when: acme_issue_result.rc > 0 and not acme_issue_result.stdout|search("Domains not changed")
  with_items: "{{ acme_issue_domains }}"
  when: acme_issue_domains is defined

- name: "Install certs if not already installed"
  become_user: '{{ acme_user }}'
  become: yes
  shell: >
      {{ acme_data_dir }}/acme.sh --installcert -d {{ item.domains[0] }}
      --key-file {{ item.key_location }} --fullchain-file {{ item.full_chain_location }}
      --reloadcmd "{{ item.reload_cmd }}"
  register: acme_install_result
  with_items: "{{ acme_issue_domains }}"
  when: acme_issue_domains is defined

- debug:
    var: acme_install_result
